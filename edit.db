CREATE DATABASE companizer_db_prod CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE companizer_db_prod;

CREATE TABLE IF NOT EXISTS `entity_comments_history` (
  `id` INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `organization_id` VARCHAR(255) NOT NULL,
  `comment_id` CHAR(36),
  `entity_type` VARCHAR(255),
  `entity_id` CHAR(36),
  `user_id` CHAR(36),
  `author_name` VARCHAR(255),
  `comment_text` TEXT,
  `processing_step` VARCHAR(100),
  `unit_price` DECIMAL(15,2),
  `accountable_id` CHAR(36),
  `created_at` TIMESTAMP NULL, 
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `manager_action_logs` (
  `id` INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  `organization_id` VARCHAR(255) NOT NULL,
  `log_id` CHAR(36),
  `accountable_id` CHAR(36),
  `action_type` VARCHAR(255),
  `entity_type` VARCHAR(255),
  `entity_id` CHAR(36),
  `processing_step` VARCHAR(100),
  `unit_price` DECIMAL(15,2),
  `details` TEXT,
  `ip_address` VARCHAR(255),
  `status` VARCHAR(100),
  `user_agent` VARCHAR(255),
  `created_at` TIMESTAMP NULL, 
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE IF NOT EXISTS `entity_workflow_rules` (
    id VARCHAR(36) PRIMARY KEY,
    collection_name VARCHAR(255) NOT NULL,
    criteria_name VARCHAR(255) NOT NULL, -- Field name in fieldsConfig
    criteria_condition VARCHAR(50), -- e.g., 'equals', '>', 'contains'
    criteria_value TEXT,
    action_role VARCHAR(100), -- 'email_notification', 'add_tag', 'validation_error'
    action_payload JSON, -- JSON content for the action (template IDs, tag names, etc.)
    is_active BOOLEAN DEFAULT TRUE,
    `created_at` TIMESTAMP NULL, 
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP  
    INDEX idx_collection_criteria (collection_name, criteria_name)
);

CREATE TABLE IF NOT EXISTS  organizations (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY NOT NULL,
    name VARCHAR(191) NOT NULL UNIQUE,
    domain VARCHAR(191) NOT NULL,
    email VARCHAR(191) NOT NULL,
    num_users INT NOT NULL,
    num_stores INT NOT NULL,
    price DECIMAL(10 , 2 ) NOT NULL,
    tenant_id CHAR(36) NOT NULL,
    `created_at` TIMESTAMP NULL
    INDEX idx_org_name (name)
)  ENGINE=INNODB;

CREATE TABLE IF NOT EXISTS  users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY NOT NULL,
    uuid CHAR(36) NOT NULL,
    first_name VARCHAR(191) NOT NULL,
    last_name VARCHAR(191) NOT NULL,
    email VARCHAR(191) NOT NULL UNIQUE,
    password_hash VARCHAR(191) NOT NULL,
    role VARCHAR(50) NOT NULL,
    organization_id BIGINT UNSIGNED NOT NULL,
    entity_id BIGINT UNSIGNED NULL,
    created_at DATETIME NOT NULL,
    INDEX idx_users_org (organization_id),
    CONSTRAINT fk_users_org FOREIGN KEY (organization_id)
        REFERENCES organizations (id)
        ON DELETE CASCADE
)  ENGINE=INNODB;
